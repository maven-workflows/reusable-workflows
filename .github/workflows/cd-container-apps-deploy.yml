name: Deploy to Azure Container Apps

on:
  workflow_call:
    inputs:
      acr_username:
        description: 'Username do ACR'
        required: true
        type: string
      acr_password:
        description: 'Password do ACR'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR Credentials
        id: acr_creds
        run: |
          ACR_USERNAME=$(az acr credential show --name "${{ vars.AZ_ACR_NAME }}" --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "${{ vars.AZ_ACR_NAME }}" --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Ativar logs detalhados do Azure CLI
        run: az config set core.logging_level=debug

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          containerAppName: ${{ github.event.repository.name }}
          resourceGroup: ${{ vars.AZ_RESOURCE_GROUP }}
          imageToDeploy: ${{ vars.AZ_ACR_NAME }}.azurecr.io/${{ github.event.repository.name }}:latest
          containerAppEnvironment: ${{ vars.AZ_ENV_NAME }}
          location: ${{ vars.AZ_LOCATION }}
          targetPort: ${{ vars.TARGET_PORT }}
          ingress: 'external'
          acrName: ${{ vars.AZ_ACR_NAME }}
          registryUsername: ${{ secrets.AZ_USERNAME }}
          registryPassword: ${{ secrets.AZ_PASSWORD }}