name: Deploy to Azure Container Apps

on:
  workflow_call:
    inputs:
      target_port:
        description: 'Porta que o container exp√µe'
        required: false
        type: string
        default: '8080'
    secrets:
      AZURE_CREDENTIALS:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./app-jar

      - name: Create Dockerfile
        run: |
          cat << EOF > Dockerfile
          FROM eclipse-temurin:21-jre
          COPY app-jar/*.jar /app.jar
          WORKDIR /
          EXPOSE ${{ inputs.target_port }}
          ENTRYPOINT ["java", "-jar", "/app.jar"]
          EOF

      - name: Build Docker Image
        id: build
        run: |
          IMAGE_TAG="${{ vars.AZ_ACR_NAME }}.azurecr.io/${{ github.event.repository.name }}:${GITHUB_SHA}"
          docker build -t "$IMAGE_TAG" .
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Push to ACR
        uses: maven-workflows/actions/.github/actions/push-acr@main
        with:
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          acr_name: ${{ vars.AZ_ACR_NAME }}
          image_tag: ${{ steps.build.outputs.image_tag }}

      - name: Deploy to Container Apps
        uses: maven-workflows/actions/.github/actions/deploy-container-app@main
        with:
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          acr_name: ${{ vars.AZ_ACR_NAME }}
          container_app_name: ${{ github.event.repository.name }}
          resource_group: ${{ vars.AZ_RESOURCE_GROUP }}
          environment_name: ${{ vars.AZ_ENV_NAME }}
          location: ${{ vars.AZ_LOCATION }}
          image_name: ${{ github.event.repository.name }}
          target_port: ${{ inputs.target_port }}